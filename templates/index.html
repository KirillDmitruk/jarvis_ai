<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>JARVIS Console</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
    background: radial-gradient(circle at center, #0b0f14 0%, #020617 100%);
    color: #e6edf3;
    overflow: hidden;
    position: relative;
    font-family: "Segoe UI", system-ui, sans-serif;
}

/* HUD круги */
.hud-circle {
    position: absolute;
    border: 1px solid rgba(14, 165, 233, 0.3);
    border-radius: 50%;
    animation: rotateCircle linear infinite;
    background: transparent;
}
.hud-circle.small { width: 120px; height: 120px; top: 10%; left: 20%; animation-duration: 25s; }
.hud-circle.medium { width: 250px; height: 250px; top: 35%; left: 65%; animation-duration: 40s; }
.hud-circle.large { width: 450px; height: 450px; top: 50%; left: 50%; transform: translate(-50%, -50%); animation-duration: 60s; }

@keyframes rotateCircle {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* HUD панели */
.hud-panel {
    position: absolute;
    padding: 10px 14px;
    font-size: 12px;
    color: #0ea5e9;
    border-radius: 10px;
    border: 1px solid rgba(14,165,233,0.2);
    box-shadow: 0 0 15px rgba(14,165,233,0.2);
    backdrop-filter: blur(4px);
    text-shadow: 0 0 3px #0ea5e9;
}
.top-left { top: 20px; left: 20px; }
.top-right { top: 20px; right: 20px; }
.bottom-left { bottom: 20px; left: 20px; }
.bottom-right { bottom: 20px; right: 20px; }

/* Центральный чат */
.chat-container {
    width: 420px;
    height: 600px;
    background: rgba(17, 24, 39, 0.85);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 40px rgba(14, 165, 233, 0.5);
    overflow: hidden;
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    border: 1px solid rgba(14, 165, 233, 0.5);
    backdrop-filter: blur(8px);
}

.header {
    padding: 14px;
    text-align: center;
    font-weight: bold;
    letter-spacing: 2px;
    background: linear-gradient(90deg, #0ea5e9, #22d3ee);
    color: #020617;
    font-size: 20px;
    text-shadow: 0 0 8px #22d3ee;
}

.messages {
    flex: 1;
    padding: 12px;
    overflow-y: auto;
    font-size: 14px;
}

.message {
    margin-bottom: 12px;
    padding: 12px 16px;
    border-radius: 12px;
    max-width: 80%;
    white-space: pre-wrap;
    line-height: 1.5;
    box-shadow: 0 0 12px rgba(14, 165, 233, 0.3);
    animation: fadeIn 0.5s ease-in;
}

.user { background: rgba(31, 41, 55, 0.8); align-self: flex-end; border-left: 2px solid #0ea5e9; }
.jarvis { background: rgba(2, 6, 23, 0.8); border: 1px solid #0ea5e9; align-self: flex-start; }

.input-area { display: flex; border-top: 1px solid rgba(31, 41, 55, 0.6); }
input {
    flex: 1;
    padding: 14px;
    border: none;
    outline: none;
    background: rgba(2, 6, 23, 0.8);
    color: #e6edf3;
    font-size: 14px;
    text-shadow: 0 0 2px #0ea5e9;
}

button {
    background: #0ea5e9;
    border: none;
    padding: 0 18px;
    cursor: pointer;
    font-weight: bold;
    color: #020617;
    transition: 0.2s;
}
button:hover { background: #22d3ee; box-shadow: 0 0 12px #22d3ee; }

.thinking { opacity: 0.6; font-style: italic; animation: pulse 1s infinite; }
@keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Панели Последние ответы и Статус системы */
.system-panel {
    position: absolute;
    top: 100px;
    padding: 12px;
    font-size: 12px;
    color: #0ea5e9;
    border-radius: 10px;
    border: 1px solid rgba(14,165,233,0.3);
    box-shadow: 0 0 20px rgba(14,165,233,0.2);
    backdrop-filter: blur(4px);
}

.left-panel { left: 24px; }
.right-panel { right: 24px; }

.panel-title { font-weight: bold; margin-bottom: 8px; text-shadow: 0 0 4px #0ea5e9; }
.panel-item { margin-bottom: 6px; }

/* Последние ответы */
#lastResponse {
    color: #22d3ee;
    max-width: 300px;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.last-response-item {
    padding: 4px 6px;
    border-left: 2px solid #0ea5e9;
    background: rgba(2, 6, 23, 0.3);
    border-radius: 4px;
    font-size: 12px;
    line-height: 1.3;
}

/* Статус API */
.status-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 6px;
    background-color: red; /* по умолчанию недоступен */
}
.status-dot.online { background-color: #0ea5e9; }
.status-dot.offline { background-color: red; }
</style>
</head>
<body>

<!-- HUD круги -->
<div class="hud-circle small"></div>
<div class="hud-circle medium"></div>
<div class="hud-circle large"></div>

<!-- HUD панели времени и погоды -->
<div class="hud-panel top-left" id="timePanel">00:00</div>
<div class="hud-panel top-right" id="datePanel">01 Января</div>
<div class="hud-panel bottom-left" id="weatherPanel">Темп: — °C</div>
<div class="hud-panel bottom-right" id="geoPanel">Локация: —</div>

<!-- Панели Последние ответы и Статус системы -->
<div class="system-panel left-panel">
    <div class="panel-title">Последние ответы</div>
    <div id="lastResponse">—</div>
</div>

<div class="system-panel right-panel">
    <div class="panel-title">Статус системы</div>
    <div class="panel-item">Порты: 8000 / 5500</div>
    <div class="panel-item">Сессия: активна</div>
    <div class="panel-item" id="apiStatus">
        <span class="status-dot offline" id="apiDot"></span> API недоступен
    </div>
</div>

<div class="chat-container">
    <div class="header">J.A.R.V.I.S.</div>
    <div class="messages" id="messages"></div>
    <div class="input-area">
        <input id="promptInput" placeholder="Сэр, ваш запрос..." />
        <button onclick="sendPrompt()">▶</button>
    </div>
</div>

<script>
const API_URL = "http://127.0.0.1:8000/requests";
const messagesEl = document.getElementById("messages");
const inputEl = document.getElementById("promptInput");
const timePanel = document.getElementById("timePanel");
const datePanel = document.getElementById("datePanel");
const weatherPanel = document.getElementById("weatherPanel");
const geoPanel = document.getElementById("geoPanel");
const lastRespEl = document.getElementById("lastResponse");
const apiDot = document.getElementById("apiDot");
const apiStatusText = document.getElementById("apiStatus");

const lastResponses = []; // массив последних ответов

// Добавление сообщений
function addMessage(text, sender){
    const div = document.createElement("div");
    div.className = `message ${sender}`;
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    if(sender === "jarvis") {
        lastResponses.push(text);
        if(lastResponses.length > 5) lastResponses.shift(); // последние 5

        lastRespEl.innerHTML = ""; // очистка панели
        lastResponses.forEach(resp => {
            const item = document.createElement("div");
            item.className = "last-response-item";
            item.textContent = truncateText(resp, 80);
            lastRespEl.appendChild(item);
        });
    }
    return div;
}

function truncateText(text,length=80){
    if(text.length <= length) return text;
    return text.slice(0,length) + "...";
}

// Загрузка истории
async function loadHistory() {
    try {
        const res = await fetch(API_URL);
        const data = await res.json();
        data.forEach(item => {
            addMessage(item.prompt, "user");
            addMessage(item.response, "jarvis");
        });
    } catch (e) {
        console.error("История не загружена", e);
    }
}

// Время и дата
function updateTime(){
    const now = new Date();
    const options = { month: 'long', day: 'numeric' };
    timePanel.textContent = now.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
    datePanel.textContent = now.toLocaleDateString('ru-RU', options);
}
setInterval(updateTime,1000);
updateTime();

// Геолокация и погода
if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
        geoPanel.textContent = `Локация: ${pos.coords.latitude.toFixed(2)}, ${pos.coords.longitude.toFixed(2)}`;
        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`)
            .then(res=>res.json())
            .then(data=>{
                weatherPanel.textContent = `Темп: ${data.current_weather.temperature}°C`;
            })
            .catch(()=>weatherPanel.textContent="Темп: — °C");
    },()=>{geoPanel.textContent="Локация: недоступна";});
}else{geoPanel.textContent="Локация: недоступна";}

// Отправка запроса
async function sendPrompt(){
    const prompt = inputEl.value.trim();
    if(!prompt) return;

    inputEl.value = "";
    addMessage(prompt, "user");
    const thinkingMsg = addMessage("Думаю, сэр...", "jarvis");
    thinkingMsg.classList.add("thinking");

    try {
        const res = await fetch(API_URL,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({prompt})
        });
        const data = await res.json();
        thinkingMsg.textContent = data.answer;
        thinkingMsg.classList.remove("thinking");
    } catch(e){
        thinkingMsg.textContent="Ошибка соединения с ядром JARVIS.";
    }
}

// Проверка статуса API
async function checkAPIStatus() {
    try {
        const res = await fetch(API_URL, { method: "GET" });
        if(res.ok){
            apiDot.classList.remove("offline");
            apiDot.classList.add("online");
            apiStatusText.innerHTML = `<span class="status-dot online"></span> API доступен`;
        } else {
            apiDot.classList.remove("online");
            apiDot.classList.add("offline");
            apiStatusText.innerHTML = `<span class="status-dot offline"></span> API недоступен`;
        }
    } catch(e){
        apiDot.classList.remove("online");
        apiDot.classList.add("offline");
        apiStatusText.innerHTML = `<span class="status-dot offline"></span> API недоступен`;
    }
}
checkAPIStatus();
setInterval(checkAPIStatus, 5000);

// Загрузка истории при старте
loadHistory();

inputEl.addEventListener("keydown",e=>{if(e.key==="Enter") sendPrompt();});
</script>

</body>
</html>
